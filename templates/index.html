<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Support Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .chat-messages {
            height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .typing-indicator::after {
            content: '.';
            animation: typing 1.5s infinite;
        }
        @keyframes typing {
            0%, 60%, 100% { content: '.'; }
            20% { content: '..'; }
            40% { content: '...'; }
        }
        .message-content {
            white-space: pre-wrap;
        }
        .message-content p {
            margin: 0.5em 0;
        }
        .message-content ul, .message-content ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }
        .message-content code {
            background: #f3f4f6;
            padding: 0.125em 0.25em;
            border-radius: 0.25em;
            font-size: 0.875em;
        }
        .message-content pre {
            background: #f3f4f6;
            padding: 0.5em;
            border-radius: 0.375em;
            overflow-x: auto;
            margin: 0.5em 0;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-80 bg-white border-r border-gray-200 flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center space-x-2">
                    <i data-lucide="bot" class="w-6 h-6 text-blue-600"></i>
                    <h1 class="text-lg font-semibold text-gray-900">AI Support Agent</h1>
                </div>
                <div class="mt-2">
                    <div id="status-indicator" class="flex items-center space-x-2 text-sm">
                        <div class="w-2 h-2 bg-gray-400 rounded-full"></div>
                        <span class="text-gray-600">Checking status...</span>
                    </div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4">
                <div class="space-y-4">
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <h3 class="font-medium text-blue-900 mb-2">Quick Actions</h3>
                        <div class="space-y-2">
                            <button onclick="checkOrderStatus()" class="w-full text-left px-3 py-2 bg-white rounded border border-blue-200 hover:bg-blue-100 transition-colors">
                                <i data-lucide="package" class="w-4 h-4 inline mr-2"></i>
                                Check Order Status
                            </button>
                            <button onclick="createSupportTicket()" class="w-full text-left px-3 py-2 bg-white rounded border border-blue-200 hover:bg-blue-100 transition-colors">
                                <i data-lucide="plus-circle" class="w-4 h-4 inline mr-2"></i>
                                Create Support Ticket
                            </button>
                            <button onclick="rebuildKnowledge()" class="w-full text-left px-3 py-2 bg-white rounded border border-blue-200 hover:bg-blue-100 transition-colors">
                                <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                                Rebuild Knowledge Base
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <h3 class="font-medium text-gray-900 mb-2">System Info</h3>
                        <div id="system-info" class="text-sm text-gray-600 space-y-1">
                            <p>Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200">
                <button onclick="clearChat()" class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                    Clear Chat
                </button>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <div class="bg-white border-b border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-900">Support Chat</h2>
                    <div id="connection-status" class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-sm text-gray-600">Connected</span>
                    </div>
                </div>
            </div>
            
            <!-- Messages -->
            <div id="chat-messages" class="chat-messages flex-1 p-4 space-y-4">
                <div class="flex justify-center">
                    <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm">
                        Welcome to AI Support! How can I help you today?
                    </div>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="bg-white border-t border-gray-200 p-4">
                <form id="chat-form" class="flex space-x-2">
                    <input 
                        type="text" 
                        id="message-input" 
                        placeholder="Type your message here..." 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        autocomplete="off"
                    >
                    <button 
                        type="submit" 
                        id="send-button"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let sessionId = null;
        let isTyping = false;

        // Initialize Lucide icons
        lucide.createIcons();

        // Check system status on load
        checkSystemStatus();

        // Chat form submission
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message || isTyping) return;
            
            addMessage('user', message);
            input.value = '';
            await sendMessage(message);
        });

        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                updateStatusIndicator(data);
                updateSystemInfo(data);
            } catch (error) {
                console.error('Error checking status:', error);
                updateStatusIndicator({ status: 'error' });
            }
        }

        function updateStatusIndicator(data) {
            const indicator = document.getElementById('status-indicator');
            const connectionStatus = document.getElementById('connection-status');
            
            if (data.status === 'healthy' && data.ollama_connected) {
                indicator.innerHTML = `
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span class="text-green-600">Online</span>
                `;
                connectionStatus.innerHTML = `
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span class="text-sm text-gray-600">Connected</span>
                `;
            } else {
                indicator.innerHTML = `
                    <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                    <span class="text-red-600">Offline</span>
                `;
                connectionStatus.innerHTML = `
                    <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                    <span class="text-sm text-gray-600">Disconnected</span>
                `;
            }
        }

        function updateSystemInfo(data) {
            const info = document.getElementById('system-info');
            info.innerHTML = `
                <p><strong>Documents:</strong> ${data.vector_store?.total_documents || 0}</p>
                <p><strong>Sessions:</strong> ${data.sessions?.active_sessions || 0}</p>
                <p><strong>Tickets:</strong> ${data.tickets?.total_tickets || 0}</p>
                <p><strong>Orders:</strong> ${data.orders?.total_orders || 0}</p>
            `;
        }

        function addMessage(role, content) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            
            if (role === 'user') {
                messageDiv.className = 'flex justify-end';
                messageDiv.innerHTML = `
                    <div class="max-w-md bg-blue-600 text-white px-4 py-2 rounded-lg">
                        <div class="message-content">${escapeHtml(content)}</div>
                    </div>
                `;
            } else {
                messageDiv.className = 'flex justify-start';
                messageDiv.innerHTML = `
                    <div class="max-w-md bg-gray-100 text-gray-900 px-4 py-2 rounded-lg">
                        <div class="message-content">${formatMarkdown(content)}</div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Re-initialize Lucide icons for new content
            lucide.createIcons();
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex justify-start';
            typingDiv.innerHTML = `
                <div class="max-w-md bg-gray-100 text-gray-900 px-4 py-2 rounded-lg">
                    <div class="typing-indicator">AI is typing</div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        async function sendMessage(message) {
            isTyping = true;
            showTypingIndicator();
            
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true;
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    sessionId = data.session_id;
                    addMessage('assistant', data.response);
                } else {
                    addMessage('assistant', `Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            } finally {
                hideTypingIndicator();
                isTyping = false;
                sendButton.disabled = false;
            }
        }

        function clearChat() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = `
                <div class="flex justify-center">
                    <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm">
                        Welcome to AI Support! How can I help you today?
                    </div>
                </div>
            `;
            sessionId = null;
        }

        async function checkOrderStatus() {
            const order_id = prompt('Please enter your order ID (e.g., ORD-001):');
            if (order_id) {
                addMessage('user', `Check order status for ${order_id}`);
                await sendMessage(`check_order_status(order_id='${order_id}')`);
            }
        }

        async function createSupportTicket() {
            const description = prompt('Please describe your issue:');
            if (description) {
                addMessage('user', `Create support ticket: ${description}`);
                await sendMessage(`create_ticket(description='${description}', priority='medium', category='general')`);
            }
        }

        async function rebuildKnowledge() {
            if (confirm('This will rebuild the knowledge base. Continue?')) {
                try {
                    const response = await fetch('/api/rebuild-knowledge', {
                        method: 'POST',
                    });
                    const data = await response.json();
                    
                    if (response.ok) {
                        alert('Knowledge base rebuilt successfully!');
                        checkSystemStatus();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                } catch (error) {
                    alert('Error rebuilding knowledge base');
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMarkdown(text) {
            // Simple markdown formatting
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/^### (.*$)/gim, '<h3 class="font-semibold text-lg mt-2 mb-1">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 class="font-semibold text-xl mt-2 mb-1">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 class="font-semibold text-2xl mt-2 mb-1">$1</h1>')
                .replace(/^\> (.*$)/gim, '<blockquote class="border-l-4 border-gray-300 pl-4 italic">$1</blockquote>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
        }

        // Auto-refresh status every 30 seconds
        setInterval(checkSystemStatus, 30000);
    </script>
</body>
</html>